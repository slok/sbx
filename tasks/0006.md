### Task 6: Firecracker Engine

**Goal:** Implement a real sandbox engine using Firecracker microVMs.

**Context:** Firecracker provides lightweight microVMs with ~125ms boot time and strong isolation. Unlike Docker (shared kernel), each sandbox runs its own kernel. This is the production engine for secure agentic workloads. Uses the task system for multi-step operations with crash recovery.

**Requirements:**

- Linux with KVM (`/dev/kvm` access)
- Firecracker binary installed (check `./bin` for the development)
- Root or appropriate capabilities
- Check https://github.com/firecracker-microvm/firecracker-go-sdk

**KVM check:**

```bash
ls -la /dev/kvm
[ -w /dev/kvm ] && echo "KVM ready" || echo "No KVM access"
```

**Deliver:**

1. Firecracker engine implementing the engine interface at `internal/sandbox/firecracker/`
2. Preflight checks before operations
3. VM lifecycle: create, start, stop, remove
4. Networking: TAP device + iptables NAT
5. Process management (spawn firecracker, track PID)
6. Exec via SSH into VM
7. Task system integration for crash recovery

**Engine interface addition:**

Add `Check` method to engine interface (all engines must implement):

```
Check() -> []CheckResult
```

CheckResult:
- ID (string) — check identifier (e.g., "kvm_available", "firecracker_binary")
- Message (string) — human readable description
- Status (string) — ok, warning, error

**Firecracker checks:**

| ID | Check | Error if |
|----|-------|----------|
| kvm_available | `/dev/kvm` exists and writable | Missing or no permission |
| firecracker_binary | `firecracker` in PATH | Not found |
| kernel_image | Kernel file exists | Missing |
| base_rootfs | Base rootfs file exists | Missing |
| ip_forward | IP forwarding enabled | Disabled (warning) |
| iptables | `iptables` available | Not found |

**Docker checks (update Task 3):**

| ID | Check | Error if |
|----|-------|----------|
| docker_binary | `docker` in PATH | Not found |
| docker_running | Docker daemon responding | Not running |
| docker_permission | Can connect to socket | Permission denied |

**CLI integration:**

```bash
# Explicit check
sbx doctor
sbx doctor --engine docker
sbx doctor --engine firecracker

# Output
Checking firecracker engine...
  ✓ kvm_available     KVM is available
  ✓ firecracker_binary Firecracker v1.6.0 found
  ✓ kernel_image      Kernel found at ~/.sbx/images/vmlinux
  ✗ base_rootfs       Missing ~/.sbx/images/ubuntu-22.04.ext4
  ⚠ ip_forward        IP forwarding disabled (may affect networking)

1 error, 1 warning
```

**Auto-check on create:**

Before `sbx create`, run checks automatically. Fail fast if any error status. Checks can be disabled with flag (--no-check).

```
$ sbx create -f sandbox.yaml
Preflight checks...
  ✗ base_rootfs: Missing ~/.sbx/images/ubuntu-22.04.ext4

Error: preflight checks failed. Run 'sbx doctor' for details.
```

**Updated SandboxConfig:**

```yaml
name: my-sandbox
engine:
  firecracker:
    kernel: ~/.sbx/images/vmlinux
    rootfs: ~/.sbx/images/ubuntu-22.04.ext4
#  docker:
#    image: ubuntu:22.04
env:
  FOO: bar
resources:
  vcpus: 2
  memory_mb: 2048
  disk_gb: 10
```

**File layout:**

```
~/.sbx/
├── sbx.db
├── images/
│   ├── vmlinux                 # Kernel
│   └── ubuntu-22.04.ext4       # Base rootfs
└── vms/
    └── <sandbox-id>/
        ├── rootfs.ext4         # Copy-on-write overlay
        ├── firecracker.sock    # API socket
        └── firecracker.pid     # Process ID
```

**Task system integration:**

| Operation | Tasks |
|-----------|-------|
| create | copy_rootfs, create_tap, setup_iptables, spawn_firecracker, configure_vm, boot_vm |
| start | boot_vm |
| stop | shutdown_vm, kill_process |
| remove | cleanup_iptables, delete_tap, delete_rootfs, delete_socket |

Example crash recovery: if CLI crashes after `create_tap`, on restart `NextTask` returns `setup_iptables` — no leaked TAP device, no duplicate setup.

**Networking:**

Each VM gets:
- TAP device: `sbx-<short-id>` (e.g., `sbx-a1b2c3`)
- Internal IP: `172.16.0.2` (VM) / `172.16.0.1` (host gateway)
- NAT via iptables for outbound internet access

```bash
# Create TAP
ip tuntap add dev sbx-a1b2c3 mode tap
ip addr add 172.16.0.1/24 dev sbx-a1b2c3
ip link set sbx-a1b2c3 up

# NAT
iptables -t nat -A POSTROUTING -o eth0 -s 172.16.0.0/24 -j MASQUERADE
iptables -A FORWARD -i sbx-a1b2c3 -o eth0 -j ACCEPT
iptables -A FORWARD -i eth0 -o sbx-a1b2c3 -m state --state RELATED,ESTABLISHED -j ACCEPT
```

**Firecracker API:**

WE can use https://github.com/firecracker-microvm/firecracker-go-sdk, however Firecracker exposes REST API over Unix socket:

- `PUT /boot-source` — kernel config
- `PUT /drives/rootfs` — rootfs drive
- `PUT /machine-config` — vcpus, memory
- `PUT /network-interfaces/eth0` — network config
- `PUT /actions` — start/stop VM

**Exec implementation:**

Unlike Docker, Firecracker VMs need SSH for exec:

1. Base rootfs includes SSH server + key
2. `sbx exec` connects via SSH to VM's internal IP
3. Delegate to `ssh` command, wire stdin/stdout/stderr

```bash
# Under the hood
ssh -i ~/.sbx/key -o StrictHostKeyChecking=no root@172.16.0.2 "ls -la"
```

**Sandbox model additions:**

- PID (int) — Firecracker process ID
- SocketPath (string) — API socket path  
- TapDevice (string) — TAP device name
- InternalIP (string) — VM's IP address

**Base image setup:**

For this task, assume base images exist at `~/.sbx/images/`. Document how to obtain them:

```bash
# Download kernel
curl -o ~/.sbx/images/vmlinux <kernel-url>

# Download rootfs
curl -o ~/.sbx/images/ubuntu-22.04.ext4 <rootfs-url>
```

Automating image creation is out of scope.

**Tests required:**

- Unit tests with mocked Firecracker socket API
- Task system integration (add tasks, complete, fail, recovery)
- Integration tests (require KVM — CI on self-hosted runner or skip)
- Create → Start → Exec → Stop → Remove lifecycle
- Network setup and cleanup
- Crash recovery: simulate crash mid-create, verify resume

**Out of scope:**

- Base image creation/download automation
- Port forwarding to host (future task)
- File sync into VM (future task)
- Lima/remote host support (future task)